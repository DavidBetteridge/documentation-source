# Document Export
To allow the real time posting of documents into external systems; typically finance systems a custom export DLL can be written which to responds to new documents being placed in the __dbo.InvoicesForPosting__ database table..

The format of document xml which is stored in this table is defined by the various document export application hooks.  (These are detailed separately.)


## Implementation
+ Create a new C# Class Library project called xyzExportProcessor. ( _xyz_ can be anything)

+ Add a reference to __Purchasing Server\bin\PROACTIS.P2P.grsCustInterfaces.dll__

+ Add a class called __Services__ which implements the __grsCustInterfaces.IExportProcessor__ interface.

+ Write an implementation of the following methods
    - __grsCustInterfaces.IExportProcessor.Initialise__.
    - __grsCustInterfaces.IExportProcessor.ProcessDocument__.
    - __grsCustInterfaces. IExportProcessor.PostingComplete__.

---

## Initialise Method

### Signature
```csharp
ExportProcessorInitialiseResult IExportProcessor.Initialise(int numberOfDocuments, string databaseTitle, string databaseName, string databaseServer)
```

### Arguments

| Argument      | Direction | Description
| ------------- | --------- | ------------ |
| numberOfDocuments    | In        | The number of pending documents in the __dbo.InvoicesForPosting__ table. |
| databaseTitle  | In        | Title of the p2p database |
| databaseName  | In        | Name of the p2p database |
| databaseServer  | In        | Name of the p2p database server |


### Returns

Returns a value from the __ExportProcessorInitialiseResult__ enumeration

0. OneTransactionPerDocument - used for posting documents individually
1. SingleTransactionForAllDocuments - used for posting all the documents in bulk

---

## ProcessDocument Method

### Signature
```csharp
ExportProcessorExportResult ProcessDocument(Guid guid, string documentNumber, string documentXml, Guid documentGuid, string documentType, string description);
```

### Arguments

| Argument      | Direction | Description
| ------------- | --------- | ------------ |
| Guid    | In        | GUID which identifies the unique entry in __dbo.DocumentsForPosting__ |
| documentNumber  | In        | The Document Number,  for example PINV1234 |
| documentXml  | In        | The XML as generated by the application hook |
| documentGuid  | In        | The GUID of the document which is being exported. (For example GUID from __dsdba.Invoices__) |
| documentType  | In        | The type of the document which is being exported. (For example INVOICE) |
| description  | In        | Name of the target system.  Always EXTERNAL in practice. |


### Returns

Returns a value from the __ExportProcessorExportResult__ enumeration

0. Success - The document was successfully posted and it's status should be updated to Posted and it's commitments released.
1. Skipped - This interface doesn't wish to post this document.
2. SuccessButDoNotMarkAsPosted - The document was successfully posted but it's status should NOT be updated to Posted and it's commitments should NOT be released. 
3. SecondarySuccess - This is not the primary document generated by an application hook.

### Error Handling

If your DLL fails to process the document then it can throw an exception up to the calling service.

_For example_
```csharp
    throw new Exception("Failed to connect to the finance system");
```

This will be recorded in the __ErrorMessage__ column of the __dbo.InvoicesForPosting__ table.

---

## PostingComplete Method

### Signature
```csharp
void PostingComplete();
```

### Arguments

None

### Returns

Void

---






### Transaction Handling

By default your code will run in a database transaction provided by the calling service.  If you wish your database code to run outside of this transaction scope,  then the following code maybe used

```csharp
using (var tx = new TransactionScope(TransactionScopeOption.Suppress))
{
    // ... your database code here...
}
```

---

## Example

See the [example applications](https://github.com/proactis-documentation/ExampleApplications/tree/master/P2P/Exports) for complete implementations.

---

## Deployment

Edit the file __"ConfigurationFolder\PROACTIS.P2P.AccountingExportService.exe.config"__ and ensure that the value for __VBProgID__ is set to blank.

```xml
<add key="VBProgID" value=""/>
```

Your dll should be complied (and named xyzExportProcessor.dll) and then copied into your __PROACTIS P2P/Plugins__  (or __Plugins/[database-title]__) folder.

